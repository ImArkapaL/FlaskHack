{% extends "base.html" %}

{% block title %}Register Student - Smart Attendance System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-user-plus me-2"></i>Register New Student
            </h1>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data" id="studentRegistrationForm">
                        <div class="row">
                            <!-- Student ID -->
                            <div class="col-md-6 mb-3">
                                <label for="student_id" class="form-label">
                                    <i class="fas fa-id-card me-1"></i>Student ID <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="student_id" name="student_id" required>
                            </div>
                            
                            <!-- First Name -->
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>First Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Last Name -->
                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Last Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required>
                            </div>
                            
                            <!-- Phone -->
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">
                                    <i class="fas fa-phone me-1"></i>Phone
                                </label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Class -->
                            <div class="col-md-6 mb-3">
                                <label for="class_name" class="form-label">
                                    <i class="fas fa-chalkboard me-1"></i>Class <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="class_name" name="class_name" required>
                                    <option value="">Select Class</option>
                                    <option value="1st">1st</option>
                                    <option value="2nd">2nd</option>
                                    <option value="3rd">3rd</option>
                                    <option value="4th">4th</option>
                                    <option value="5th">5th</option>
                                    <option value="6th">6th</option>
                                    <option value="7th">7th</option>
                                    <option value="8th">8th</option>
                                    <option value="9th">9th</option>
                                    <option value="10th">10th</option>
                                    <option value="11th">11th</option>
                                    <option value="12th">12th</option>
                                </select>
                            </div>
                            
                            <!-- Section -->
                            <div class="col-md-6 mb-3">
                                <label for="section" class="form-label">
                                    <i class="fas fa-layer-group me-1"></i>Section <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="section" name="section" required>
                                    <option value="">Select Section</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Father's Name -->
                            <div class="col-md-6 mb-3">
                                <label for="father_name" class="form-label">
                                    <i class="fas fa-male me-1"></i>Father's Name
                                </label>
                                <input type="text" class="form-control" id="father_name" name="father_name">
                            </div>
                            
                            <!-- Mother's Name -->
                            <div class="col-md-6 mb-3">
                                <label for="mother_name" class="form-label">
                                    <i class="fas fa-female me-1"></i>Mother's Name
                                </label>
                                <input type="text" class="form-control" id="mother_name" name="mother_name">
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Address -->
                            <div class="col-12 mb-3">
                                <label for="address" class="form-label">
                                    <i class="fas fa-home me-1"></i>Address
                                </label>
                                <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <!-- Face Photo Capture -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-camera me-1"></i>Student Photo <span class="text-danger">*</span>
                            </label>
                            <div class="camera-section p-3 border rounded">
                                <div class="video-container text-center mb-3">
                                    <video id="registrationVideo" width="300" height="225" autoplay playsinline class="border rounded"></video>
                                    <canvas id="registrationCanvas" style="display: none;"></canvas>
                                </div>
                                <div class="text-center">
                                    <button type="button" id="capturePhotoBtn" class="btn btn-primary me-2">
                                        <i class="fas fa-camera me-1"></i>Capture Photo
                                    </button>
                                    <button type="button" id="retakePhotoBtn" class="btn btn-outline-secondary" style="display: none;">
                                        <i class="fas fa-redo me-1"></i>Retake
                                    </button>
                                </div>
                                <div id="capturedPhotoPreview" class="mt-3 text-center" style="display: none;">
                                    <img id="capturedPhoto" src="" alt="Captured" class="img-thumbnail" style="max-width: 200px;">
                                </div>
                                <input type="hidden" id="capturedImageData" name="face_image_data">
                            </div>
                            <div class="form-text">
                                Position the student's face in the camera frame and click capture.
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('manage_students') }}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-1"></i>Register Student
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Camera handling for registration
let registrationStream = null;
let hasCapturedPhoto = false;

document.addEventListener('DOMContentLoaded', function() {
    initializeRegistrationCamera();
    
    document.getElementById('capturePhotoBtn').addEventListener('click', captureRegistrationPhoto);
    document.getElementById('retakePhotoBtn').addEventListener('click', retakePhoto);
    
    // Form submission handling
    document.getElementById('studentRegistrationForm').addEventListener('submit', function(e) {
        if (!hasCapturedPhoto) {
            e.preventDefault();
            alert('Please capture a photo before submitting the form.');
            return;
        }
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Registering...';
        submitBtn.disabled = true;
    });
});

async function initializeRegistrationCamera() {
    try {
        registrationStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 300, height: 225 }
        });
        document.getElementById('registrationVideo').srcObject = registrationStream;
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Camera access denied. Please allow camera access to register students.');
    }
}

function captureRegistrationPhoto() {
    const video = document.getElementById('registrationVideo');
    const canvas = document.getElementById('registrationCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Display captured photo
    document.getElementById('capturedPhoto').src = imageData;
    document.getElementById('capturedPhotoPreview').style.display = 'block';
    document.getElementById('capturedImageData').value = imageData;
    
    // Hide video, show retake button
    video.style.display = 'none';
    document.getElementById('capturePhotoBtn').style.display = 'none';
    document.getElementById('retakePhotoBtn').style.display = 'inline-block';
    
    hasCapturedPhoto = true;
}

function retakePhoto() {
    const video = document.getElementById('registrationVideo');
    
    // Show video, hide captured photo
    video.style.display = 'block';
    document.getElementById('capturedPhotoPreview').style.display = 'none';
    document.getElementById('capturePhotoBtn').style.display = 'inline-block';
    document.getElementById('retakePhotoBtn').style.display = 'none';
    document.getElementById('capturedImageData').value = '';
    
    hasCapturedPhoto = false;
}
</script>
{% endblock %}
